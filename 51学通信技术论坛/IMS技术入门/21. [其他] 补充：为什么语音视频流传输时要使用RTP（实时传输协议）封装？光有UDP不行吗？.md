## [其他] 补充：为什么语音视频流传输时要使用RTP（实时传输协议）封装？光有UDP不行吗？

	Internet是一个数据传输网络，采用分组交换技术。分组交换和电路交换不同，不再采用时分复用技术（TDM)，而是采用统计复用技术。IP是一种尽力而为的网络层传输技术，它不对分组传输提供质量保证。对于实时应用，如分组语音、视频会议等，其主要的质量要求是端到端延迟、时延抖动和分组丢失率。

	端到端时延如果小于150ms，人的听力并不能察觉到；如果端到端时延位于150ms和400ms之间，虽然对人的听力造成一定影响，但可以接受；如果端到端时延大于400ms，则将严重影响语音会话的交互性。

	与端到端时延相比，更能影响语音或视频传输质量的问题是时延抖动，由于Internet是分组交换网络，数据分组采用存储转发方式传送。而数据分组在队列中的排队时间是随机变化的，就像两个人开车从同一地点出发，到达同一目的地，但出发时间前后相差一小时，他们到达目的地的时间差肯定不会精确到一小时。如果后一个人恰巧碰到交通阻塞，可能延迟几个小时才能到达目的地。

	最后一个质量要求是分组丢失率。IP并不能保证分组正确到达目的地，选择好的传输层协议，如TCP，可以通过重传解决分组丢失问题，但对于实时应用，根本不能容忍重传数据分组所造成的巨大时延（比如你正在电话对爱人说“我爱你”，但这句话在网络中丢失了，结果过了2秒再重新发送“我爱你”给你的爱人，你认为有意义吗？），因此TCP对实时应用并不适用。实时应用往往选择UDP作为传输层协议，但UDP仍然无法解决分组丢失和分组失序的问题。

	另外，在数据网络中还支持多种多媒体传输的技术，包括差分服务(DiffServ)、综合服务(IntServ)及组播等。由于应用这些技术，属于实时应用的数据分组的端到端时延可以控制在用户可以接受的范围内，而且也可以把时延抖动和分组丢失率控制在一个合理的范围内，但由于存在时延抖动、分组丢失及分组失序等问题，使得实时应用数据的发送者和接收者之间的同步问题变得十分复杂。

	在一个分组语音应用中，语音信号和静音（即通话时，双方都不搭理对方，没人说话）交替出现。为了节省带宽，通常只在出现语音信号时，才进行采样并传送由采样后的数字语音数据构成的数据分组。假定语音信号的采样频率为8000Hz，样值由8位二进制数据标识，每20ms采样到的语音数据构成一个数据块，由此可以计算出数据块的长度为20ms*8K字节/s=160字节，通常给这160字节长度的数据块加上首部，并将加上首部后的数据块封装成UDP分组通过网络传输到目的终端。在发送端存在语音信号阶段，这样的UDP分组每隔20ms发送一个。

	如果UDP分组端到端的传输时延不仅小而且固定不变，能保证接收者每隔20ms接收到一个UDP分组，在这种理想情况下，接收者只需每接收到一个UDP分组，就立即将分组中包含的数字语音数据播放出来即可。然而，事实并非如此，有些分组可能在传输过程中丢失，而且即使在没有拥塞的情况下，端到端时延也不可能一成不变。这样一来，接收者必须通过某种机制确定何时播放某个数据块，以及对丢失的数据块做何处理。

	在类似于分组语音等实时应用中，接收者必须能够提供某种同步播放机制，使得在网络存在时延抖动的情况下，仍然能够正确播放数据块中的数字语音数据。这种同步机制，可通过下述3种机制的组合得以实现：
	（1）在每一数据块前面附加序号：发送者对发送的每一数据块都附加一个序号，每发送一个数据块，序号加1；
	（2）在每一数据块前面附加时间戳，发送者对发送的每一数据块都附加数据块产生的时间；
	（3）延迟播放：接收者对接收到的数据块延迟一段时间后，再予以播放，而且延迟时间必须长到足以使绝大多数数据块都能够在预期播放它们的时间之前到达接收者。延迟时间可以在整个语音会话期间一直不变，也可以在语音会话期间动态调整，所有不能在预期播放时间之前到达的数据块都将被当作丢失数据块。当然，接收者可以通过类似内插等编码机制努力消除因丢失分组对语音质量造成的影响。

	RTP在协议结构中的位置在UDP之上、应用层之下。应用层产生的实时数据首先被封装成RTP分组格式，然后再将RTP分组封装成UDP分组格式，通过传输层进行传送。实时应用采用UDP而非TCP作为传输层协议的理由是显而易见的，因为TCP等待确认应答及重新传输丢失的数据分组机制使得实时数据的传输时延变得很长而且不可预测。但一旦采用UDP，又无法检测分组丢失、错序等。

	为了正确还原音频或视频信号，必须保持采样和播放之间的同步关系，这种同步关系就通过实时数据块所携带的时间戳来实现，而UDP分组格式并不支持时间戳功能。

	为了确定分组顺序，检测分组丢失，必须对分组进行编号。同样，UDP分组格式也不支持序号功能。

	基于以上原因，引入了RTP的封装。RTP提供了正确播放实时数据必需的、但UDP又不支持的这些功能，主要包括时间戳、序号等。